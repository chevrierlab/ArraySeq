---
title: "ArraySeq_Probe_Design"
author: "Denis"
date: "9/24/2020"
output: html_document
---

**Generating Barcodes for 1M Array**


We need 974,016 spatial barcodes for the M1 array. To make these barcodes robust, we want to make them such that if there is a substitution error during PCR or sequencing, that the read will not be mapped onto the wrong spatial position because the mutation caused it to match another barcode in a different position. 


```{r, warning=FALSE}
library(DNABarcodes)
library(tidyverse)
library(DNABarcodes)
library(stringr)
library(tidyr)
library(Biostrings)
```


Generating barcodes and joining all combinations of two random samples:
```{r, message=FALSE, warning=FALSE}
set.seed(1234)
barcodes <- create.dnabarcodes.conway(n=9, dist = 3) #Generates a list of 7180 barcodes of length 9 and hamming distance of 3
length(barcodes) #Generates 2595 barcodes of lenght 9 and hamming distance of 3 (where any one substitution mutation could be detected because the resulting barcode would not be in the original pool).

all_combinations <- expand.grid(barcodes, barcodes) #creating all combinations of paired barcodes from this original pool
nrow(all_combinations) #creates 6,734,025 unique combinations
joined_barcodes <- paste(all_combinations$Var1, all_combinations$Var2, sep = "") #join 9-mers into single, unique 18-mer barcodes that maintain their hamming distance properties
```


Filtering barcodes that do not follow the xths_v2 project rules:
```{r}
#Filtering on rule a:
joined_barcodes <- joined_barcodes[!grepl("^CC|GG$", joined_barcodes)]
#Filtering on rule b1:
joined_barcodes <- joined_barcodes[!grepl("^AC", joined_barcodes)]
#Filtering on rule b2:
joined_barcodes <- joined_barcodes[!grepl("(.)\\1{2,}", joined_barcodes)]
length(joined_barcodes)
#All barcodes have 50% GC frequence so they all pass GC filter (as they did in the initial analysis that was run).
```



```{r}
sampled_barcodes <- sample(joined_barcodes, 974016, replace = FALSE) #Sample 974,016 barcodes from the full set
head(sampled_barcodes)
```


```{r}
#Concatenating Anchor 1 and Anchor 2 to the barcodes
probes <- paste("CTGGCCGTCGTTTTAC", sampled_barcodes, "AGATCGGAAGAGCGTCGTGTAGGG", sep = "")
head(probes)
```

```{r}
#The length of the Array-Seq probes
nchar(probes[1])
```


```{r}
write(probes, "Array_Probe_Design.txt")
sampled_barcodes <- as.vector(reverseComplement(DNAStringSet(sampled_barcodes)))
write(sampled_barcodes, "ArraySeq_Barcodes.txt")

```

```{r}
sessionInfo()
```
